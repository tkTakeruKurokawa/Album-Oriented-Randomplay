#!/usr/bin/env sh

# prepare-commit-msgフック
# ブランチ名に基づいてコミットメッセージのプレフィックスを自動追加

COMMIT_EDITMSG=$1
COMMIT_SOURCE=$2

# マージコミット、amend、squashの場合は何もしない
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
  exit 0
fi

# ブランチ名を取得
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)

# ブランチ名がない場合（detached HEAD状態）は何もしない
if [ -z "$BRANCH_NAME" ]; then
  exit 0
fi

# main/master/develop/releaseブランチの場合は何もしない
if echo "$BRANCH_NAME" | grep -qE '^(main|master|develop|release/.*)$'; then
  exit 0
fi

# ブランチ名からConventional Commitsのプレフィックスを判定
PREFIX=""
if echo "$BRANCH_NAME" | grep -qE '^(feature|feat)/'; then
  PREFIX="feat: "
elif echo "$BRANCH_NAME" | grep -qE '^(fix|bugfix|hotfix)/'; then
  PREFIX="fix: "
elif echo "$BRANCH_NAME" | grep -qE '^docs/'; then
  PREFIX="docs: "
elif echo "$BRANCH_NAME" | grep -qE '^style/'; then
  PREFIX="style: "
elif echo "$BRANCH_NAME" | grep -qE '^refactor/'; then
  PREFIX="refactor: "
elif echo "$BRANCH_NAME" | grep -qE '^test/'; then
  PREFIX="test: "
elif echo "$BRANCH_NAME" | grep -qE '^(chore|build|ci)/'; then
  PREFIX="chore: "
elif echo "$BRANCH_NAME" | grep -qE '^perf/'; then
  PREFIX="perf: "
fi

# プレフィックスがある場合のみ処理
if [ -n "$PREFIX" ]; then
  # 既存のコミットメッセージを読み取り
  CURRENT_MSG=$(cat "$COMMIT_EDITMSG")

  # 既にConventional Commitsの形式になっている場合は何もしない
  if echo "$CURRENT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|ci|build|perf|revert)(\(.+\))?:'; then
    exit 0
  fi

  # コメント行や空行の場合は何もしない
  if echo "$CURRENT_MSG" | grep -qE '^(#|$)'; then
    exit 0
  fi

  # プレフィックスを追加
  echo "${PREFIX}${CURRENT_MSG}" > "$COMMIT_EDITMSG"
fi